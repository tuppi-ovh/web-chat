<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ChatGPT Pro</title>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<style>
body { font-family:sans-serif; max-width:320px; margin:auto; padding:6px; }
#tabs button { font-size:12px; margin:2px; }
#chat { border:1px solid #ccc; height:300px; overflow-y:auto; padding:6px; }
.user { color:blue }
.bot { color:green }
</style>
</head>
<body>

<h3>ChatGPT Pro v2.0</h3>

<input id="token" type="password" placeholder="Token">
<button onclick="init()">OK</button>

<div id="app" style="display:none">

<div id="tabs"></div>
<button onclick="newChat()">+ Chat</button>
<button onclick="deleteChat()">üóë</button>
<button onclick="renameChat()">‚úèÔ∏è</button>
<button onclick="exportChat()">‚¨áÔ∏è</button>
<button onclick="importChat()">‚¨ÜÔ∏è</button>

<div id="chat"></div>

<input id="input">
<button onclick="send()">Send</button>

</div>

<script>
const BACKEND = "https://web-chat-alpha-two.vercel.app/api/chat";
const MAX_CHATS = 10;

let token;
let chats = JSON.parse(localStorage.getItem("chats") || "[]");
if (chats.length === 0)
  chats = [{ name:"Chat 1", messages:[] }];

let current = 0;

function save() {
  localStorage.setItem("chats", JSON.stringify(chats));
}

function init() {
  token = document.getElementById("token").value;
  document.getElementById("app").style.display="block";
  renderTabs(); renderChat();
}

function renderTabs() {
  const t = document.getElementById("tabs");
  t.innerHTML="";
  chats.forEach((c,i)=>{
    const b=document.createElement("button");
    b.textContent=c.name;
    if(i===current) b.style.fontWeight="bold";
    b.onclick=()=>{current=i;renderTabs();renderChat();}
    t.appendChild(b);
  });
}

function renderChat() {
  const c=document.getElementById("chat");
  c.innerHTML="";
  chats[current].messages.forEach(m=>{
    const d=document.createElement("div");
    d.className=m.role==="user"?"user":"bot";
    d.innerHTML=marked.parse(m.content);
    c.appendChild(d);
  });
  c.scrollTop=c.scrollHeight;
}

async function send() {
  const text=input.value.trim();
  if(!text) return;
  input.value="";
  chats[current].messages.push({role:"user",content:text});
  renderChat();

  const res=await fetch(BACKEND,{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      "x-secret":token
    },
    body:JSON.stringify({
      history: chats[current].messages,
      message: text
    })
  });
  const data=await res.json();
  chats[current].messages.push({role:"assistant",content:data.reply});
  chats[current].messages = chats[current].messages.slice(-50);
  save(); renderChat();
}

function newChat(){
  if(chats.length>=MAX_CHATS) return alert("Max 10");
  chats.push({name:`Chat ${chats.length+1}`,messages:[]});
  current=chats.length-1;
  save(); renderTabs(); renderChat();
}

function deleteChat(){
  if(chats.length===1) return;
  chats.splice(current,1);
  current=0;
  save(); renderTabs(); renderChat();
}

function renameChat(){
  const n=prompt("Nom du chat",chats[current].name);
  if(n){ chats[current].name=n; save(); renderTabs(); }
}

function exportChat(){
  const data = JSON.stringify(chats[current],null,2);
  navigator.clipboard.writeText(data);
  alert("Chat copi√© dans le presse-papiers");
}

function importChat(){
  const json=prompt("Colle le JSON du chat");
  try{
    const obj=JSON.parse(json);
    if(obj.messages){
      chats.push(obj);
      current=chats.length-1;
      save(); renderTabs(); renderChat();
    }
  }catch(e){ alert("JSON invalide"); }
}
</script>
</body>
</html>
