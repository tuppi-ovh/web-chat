<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ChatGPT Pro Vision</title>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<style>
body {
  background:#111;
  color:#eee;
  font-family:sans-serif;
  max-width:360px;
  margin:auto;
  padding:8px;
}

button {
  background:#222;
  color:#eee;
  border:1px solid #444;
  padding:4px 6px;
  margin:2px;
}

#chat {
  border:1px solid #333;
  height:320px;
  overflow-y:auto;
  padding:6px;
  margin:6px 0;
}

.user { color:#6ab0ff }
.bot { color:#9dff9d }

textarea {
  width:100%;
  height:60px;
  background:#000;
  color:#fff;
  border:1px solid #333;
}

input[type=file] {
  color:#ccc;
}
</style>
</head>
<body>

<h3>ChatGPT Pro Vision v3</h3>

<input id="token" type="password" placeholder="Token">
<button onclick="init()">OK</button>

<div id="app" style="display:none">

<div id="tabs"></div>
<button onclick="newChat()">+ Chat</button>
<button onclick="deleteChat()">üóë</button>
<button onclick="renameChat()">‚úèÔ∏è</button>
<button onclick="exportChat()">‚¨áÔ∏è</button>
<button onclick="importChat()">‚¨ÜÔ∏è</button>

<div id="chat"></div>

<textarea id="input" placeholder="Message (3 lignes max)"></textarea>
<input type="file" id="image" accept="image/*">
<br>
<button onclick="send()">Send</button>

</div>

<script>
const BACKEND = "https://web-chat-alpha-two.vercel.app/api/chat";
const MAX_CHATS = 10;

let token;
let chats = JSON.parse(localStorage.getItem("chats") || "[]");
if (chats.length === 0)
  chats = [{ name:"Chat 1", messages:[] }];

let current = 0;

function save() {
  localStorage.setItem("chats", JSON.stringify(chats));
}

function init() {
  token = document.getElementById("token").value;
  document.getElementById("app").style.display="block";
  renderTabs(); renderChat();
}

function renderTabs() {
  const t = document.getElementById("tabs");
  t.innerHTML="";
  chats.forEach((c,i)=>{
    const b=document.createElement("button");
    b.textContent=c.name;
    if(i===current) b.style.fontWeight="bold";
    b.onclick=()=>{current=i;renderTabs();renderChat();}
    t.appendChild(b);
  });
}

function renderChat() {
  const c=document.getElementById("chat");
  c.innerHTML="";
  chats[current].messages.forEach(m=>{
    const d=document.createElement("div");
    d.className=m.role==="user"?"user":"bot";
    d.innerHTML=marked.parse(m.content);
    c.appendChild(d);
  });
  c.scrollTop=c.scrollHeight;
}

async function send() {
  const text=input.value.trim();
  if(!text) return;
  input.value="";

  let imageBase64 = null;
  const file = document.getElementById("image").files[0];
  if(file){
    imageBase64 = await toBase64(file);
    document.getElementById("image").value="";
  }

  chats[current].messages.push({role:"user",content:text});
  renderChat();

  const res=await fetch(BACKEND,{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      "x-secret":token
    },
    body:JSON.stringify({
      history: chats[current].messages,
      message: text,
      imageBase64
    })
  });

  const data=await res.json();
  chats[current].messages.push({role:"assistant",content:data.reply});
  chats[current].messages = chats[current].messages.slice(-50);
  save(); renderChat();
}

function toBase64(file){
  return new Promise((res)=>{
    const r=new FileReader();
    r.onload=()=>res(r.result.split(",")[1]);
    r.readAsDataURL(file);
  });
}

function newChat(){
  if(chats.length>=MAX_CHATS) return;
  chats.push({name:`Chat ${chats.length+1}`,messages:[]});
  current=chats.length-1;
  save(); renderTabs(); renderChat();
}

function deleteChat(){
  if(chats.length===1) return;
  chats.splice(current,1);
  current=0;
  save(); renderTabs(); renderChat();
}

function renameChat(){
  const n=prompt("Nom",chats[current].name);
  if(n){ chats[current].name=n; save(); renderTabs(); }
}

function exportChat(){
  const data = JSON.stringify(chats[current],null,2);
  navigator.clipboard.writeText(data);
  alert("Chat copi√©");
}

function importChat(){
  const json=prompt("Colle le JSON");
  try{
    const obj=JSON.parse(json);
    if(obj.messages){
      chats.push(obj);
      current=chats.length-1;
      save(); renderTabs(); renderChat();
    }
  }catch(e){ alert("JSON invalide"); }
}
</script>
</body>
</html>
